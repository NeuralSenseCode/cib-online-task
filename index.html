<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Brand × Attribute — Forced-Choice Task</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0d12;
      --fg: #e9edf1;
      --muted: #9aa3ad;
      --accent: #58a6ff;
      --card: #171a20;
      --card2:#1e232b;
    }
    html, body { height:100%; }
    body {
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", sans-serif;
      color: var(--fg); background: linear-gradient(180deg, #0b0d12, #10131a);
      display:flex; align-items:center; justify-content:center;
    }
    .container { width:min(920px, 92vw); }
    .card {
      background: radial-gradient(1000px 500px at -20% -40%, #162032 0%, transparent 70%), var(--card);
      border:1px solid #232a34; border-radius:16px; padding:28px; box-shadow: 0 12px 40px rgba(0,0,0,0.35);
    }
    h1, h2 { margin: 0 0 12px; }
    h1 { font-size: 28px; letter-spacing: .2px; }
    h2 { font-size: 20px; color: var(--muted); font-weight: 500; }
    p  { color: #cfd7e1; line-height: 1.55; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:8px; flex:1 1 260px; }
    input[type="text"] {
      background: var(--card2); color:var(--fg); border:1px solid #2a3140; border-radius:10px; padding:12px 14px; font-size:16px;
      outline: none;
    }
    button {
      background: var(--accent); color:#0b1220; border:none; border-radius:10px; padding:12px 16px; font-size:16px; font-weight:700;
      cursor:pointer;
    }
    button.secondary { background:#2a3140; color:#dbe6f5; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .center { text-align:center; }
    .mt16{ margin-top:16px; } .mt24{ margin-top:24px;} .mt8{ margin-top:8px;}
    .hidden { display:none !important; }
    .legend { color:#97a3b6; font-size:14px; }

    /* Trial layout */
    .trial { min-height: 340px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .stim-attr { font-size: 28px; font-weight: 800; letter-spacing:.4px; margin-bottom: 10px; text-transform: uppercase; }
    .stim-brand { font-size: 22px; font-weight: 600; color:#c8d4e6; margin-bottom: 24px; }
    .options { display:flex; gap:16px; align-items:center; justify-content:center; }

    .option {
      background: #1b2130; border:1px solid #2a3140; color:#e8f1ff; padding:14px 18px; border-radius:12px; min-width: 180px;
      display:flex; align-items:center; gap:10px; font-size:18px; cursor:pointer; user-select:none; transition: transform .05s ease;
    }
    .option:hover { transform: translateY(-1px); }
    .option.fit { border-color: #2c5f3a; }
    .option.not { border-color: #4c2c2c; }

    .key {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#0f1115; border:1px solid #2a3140; padding:3px 7px; border-radius:6px; font-size:14px; color:#cbd7e8;
    }

    /* Fixation cross (no extra text) */
    .fixation {
      font-size: 48px; color:#b7c1d1; letter-spacing:2px; text-align:center;
      height:200px; display:flex; align-items:center; justify-content:center;
    }

    /* Countdown ring moved to center (between buttons) */
    .timer-wrap { position: static; width:64px; height:64px; }
    .options .timer-wrap { margin: 0 4px; }
    .timer { position:relative; width:64px; height:64px; }
    .timer svg { transform: rotate(-90deg); }
    .timer .time {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:14px; color:#cfe0ff;
      font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,.4);
    }

    .footer { color:#8fa0b8; font-size:13px; }
    .toast {
      background: #2a3140; color:#e8f1ff; padding:10px 14px; border-radius:10px; border:1px solid #3b4659; display:inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Welcome -->
    <div class="card" id="screen-welcome">
      <h1>Brand × Attribute — Forced-Choice</h1>
      <h2>Quick setup</h2>
      <div class="row mt16">
        <div class="field">
          <label for="pname">Your name</label>
          <input id="pname" type="text" placeholder="Type your full name…" />
        </div>
      </div>
      <p class="mt16 footer">Respond quickly using <span class="key">←</span> Fit and <span class="key">→</span> Doesn’t fit. 5 seconds per screen.</p>
      <div class="mt24"><button id="btn-begin">Begin</button></div>
    </div>

    <!-- Instructions -->
    <div class="card hidden" id="screen-instructions">
      <h1>Instructions</h1>
      <p>On each screen you’ll see an <strong>Attribute</strong> and a <strong>Bank</strong>.</p>
      <p>Decide quickly whether the attribute <em>fits</em> the bank:</p>
      <ul>
        <li><span class="key">←</span> Fit</li>
        <li><span class="key">→</span> Doesn’t fit</li>
      </ul>
      <p class="legend">You’ll have <strong>5 seconds</strong> per screen. We’ll start with 3 short practice trials.</p>
      <div class="mt24">
        <button class="secondary" id="btn-instr-back">Back</button>
        <button id="btn-instr-next">Start practice</button>
      </div>
    </div>

    <!-- Practice -->
    <div class="card hidden" id="screen-practice">
      <h1>Practice</h1>
      <div id="practice-stage"></div>
    </div>

    <!-- Prelude -->
    <div class="card hidden" id="screen-prelude">
      <h1>All set</h1>
      <p class="mt8">Let’s begin the actual task. Same rules, just a few more screens.</p>
      <div class="mt24"><button id="btn-start-main">Begin the task</button></div>
    </div>

    <!-- Trial -->
    <div class="card hidden" id="screen-trial"><div id="trial-stage"></div></div>

    <!-- Finish -->
    <div class="card hidden" id="screen-finish">
      <h1>Finished</h1>
      <p class="mt8">Thanks for your time. Click <strong>Submit</strong> to finalize your session.</p>
      <div class="mt24"><button id="btn-submit">Submit</button></div>
      <div class="mt8"><div id="submit-status" class="toast hidden">Submitting…</div></div>
    </div>

    <!-- Done -->
    <div class="card hidden" id="screen-done">
      <h1>All done</h1>
      <p class="mt8">You may now close this window.</p>
    </div>
  </div>

  <script>
/* ===== CONSOLIDATED ES5-COMPAT SCRIPT ===== */

/* ---- CONFIG ---- */
var FRONTEND_CONFIG = {
  BACKEND_URL: "https://script.google.com/macros/s/AKfycbxwRTN6qWWnRnd44z1WJSWz5yzCNfFQBgi695UxM1DelEaFMcekkZKFGTiAXBvh2ZpP/exec",
  PRACTICE_COUNT: 3,
  TRIAL_TIMEOUT_MS: 5000,
  FIXATION_MS: 1000
};

/* ---- STIMULI ---- */
var BRANDS = ["Standard Bank CIB","RMB","Investec","Nedbank","ABSA","Deutsche Bank"];
var ATTRIBUTES = [
  "Global","Easy to deal with","Understands your business needs","Committed to your success",
  "Most innovative","Best investment bank in South Africa","Uses digital solutions to advance your goals",
  "Trusted partner","Responsive","Thought leadership","Strong execution"
];
var PRACTICE_PAIRS = [
  { attribute: "Global", brand: "Standard Bank CIB" },
  { attribute: "Innovative", brand: "Investec" },
  { attribute: "Responsive", brand: "RMB" }
];

/* ---- UTILS ---- */
function sleep(ms){ return new Promise(function(r){ setTimeout(r, ms); }); }
function shuffle(arr){
  return arr.map(function(v){ return [Math.random(), v]; })
            .sort(function(a,b){ return a[0]-b[0]; })
            .map(function(x){ return x[1]; });
}
function uuid(){
  try { if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID(); } catch(e){}
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){
    var r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
    return v.toString(16);
  });
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}
function envInfo(){
  var tz = null;
  try { tz = Intl.DateTimeFormat().resolvedOptions().timeZone || null; } catch(e){}
  var sw = (window.screen && window.screen.width) ? window.screen.width : 0;
  var sh = (window.screen && window.screen.height) ? window.screen.height : 0;
  return { user_agent: navigator.userAgent, screen: sw + "x" + sh, tz: tz };
}
function getOptionTarget(target){
  var el = target;
  while (el && el !== document){
    if (el.classList && el.classList.contains("option")) return el;
    el = el.parentNode;
  }
  return null;
}

/* ---- STATE ---- */
var state = {
  sessionId: uuid(),
  participantName: "",
  startedAt: new Date().toISOString(),
  practiceIdx: 0,
  practiceDone: false,
  trials: [],
  trialIdx: 0,
  currentTrial: null,
  pendingQueue: [],
  practicePass: 0
};

/* ---- NETWORK (FormData to avoid preflight) ---- */
function postJSON(url, data){
  var fd = new FormData();
  fd.append('rows', JSON.stringify(data.rows || []));
  return fetch(url, { method: "POST", body: fd, keepalive: true })
    .then(function(res){ return res.json().catch(function(){ return {}; }); })
    .catch(function(){ return {error:"net"}; });
}
function logEvent(event){
  try {
    var payload = Object.assign({ session_id: state.sessionId, participant: state.participantName, ts: new Date().toISOString() }, envInfo(), event);
    state.pendingQueue.push(payload);
    try { localStorage.setItem("fc_queue_" + state.sessionId, JSON.stringify(state.pendingQueue)); } catch(e){}
    if (FRONTEND_CONFIG.BACKEND_URL && FRONTEND_CONFIG.BACKEND_URL.indexOf("http") === 0){
      var copy = state.pendingQueue.slice(0);
      return postJSON(FRONTEND_CONFIG.BACKEND_URL, {rows: copy}).then(function(res){
        if (!res.error){
          state.pendingQueue.length = 0;
          try { localStorage.removeItem("fc_queue_" + state.sessionId); } catch(e){}
        }
      });
    }
  } catch(e){}
  return Promise.resolve();
}
window.addEventListener("beforeunload", function(){
  try {
    var url = FRONTEND_CONFIG.BACKEND_URL;
    if (!url) return;
    // JSON fallback for beacon; backend should handle both JSON and FormData
    var data = JSON.stringify({rows: state.pendingQueue});
    if (navigator.sendBeacon) navigator.sendBeacon(url, data);
  } catch(e){}
});

/* ---- DOM HELPERS ---- */
function $(id){ return document.getElementById(id); }
var screens = {};
function show(name){
  Object.keys(screens).forEach(function(k){ screens[k].classList.add("hidden"); });
  screens[name].classList.remove("hidden");
}

/* ---- TRIALS ---- */
function buildTrials(){
  var full = [];
  for (var i=0;i<ATTRIBUTES.length;i++){
    for (var j=0;j<BRANDS.length;j++){
      full.push({attribute: ATTRIBUTES[i], brand: BRANDS[j]});
    }
  }
  state.trials = shuffle(full);
  state.trialIdx = 0;
}
function practiceList(){
  if (PRACTICE_PAIRS && PRACTICE_PAIRS.length >= FRONTEND_CONFIG.PRACTICE_COUNT)
    return PRACTICE_PAIRS.slice(0, FRONTEND_CONFIG.PRACTICE_COUNT);
  var full = [];
  for (var i=0;i<ATTRIBUTES.length;i++) for (var j=0;j<BRANDS.length;j++) full.push({attribute:ATTRIBUTES[i], brand:BRANDS[j]});
  return shuffle(full).slice(0, FRONTEND_CONFIG.PRACTICE_COUNT);
}

function runPractice(){
  show("practice");
  var practice = practiceList();
  var stage = $("practice-stage");
  (function loop(){
    if (state.practicePass >= FRONTEND_CONFIG.PRACTICE_COUNT){ show("prelude"); return; }
    var stim = practice[state.practicePass];
    runOneTrial(stage, stim, true).then(function(ok){
      if (ok) state.practicePass += 1;
      loop();
    });
  })();
}
function runMain(){
  var stage = $("trial-stage");
  (function loop(){
    if (state.trialIdx >= state.trials.length){ show("finish"); return; }
    var stim = state.trials[state.trialIdx];
    runOneTrial(stage, stim, false).then(function(){
      state.trialIdx += 1;
      loop();
    });
  })();
}

/* Core trial; returns Promise<boolean> (responded vs timeout) */
function runOneTrial(stageEl, stim, isPractice){
  // Fixation — crosshair only
  stageEl.innerHTML = '<div class="fixation">+</div>';

  return sleep(FRONTEND_CONFIG.FIXATION_MS).then(function(){
    var trialId = uuid();
    var start = performance.now();
    var ended = false, timedOut = false, rt = null, response = null;

    // Trial UI — timer centered between buttons
    stageEl.innerHTML =
      '<div class="trial">' +
        '<div class="stim-attr">' + escapeHtml(stim.attribute) + '</div>' +
        '<div class="stim-brand">' + escapeHtml(stim.brand) + '</div>' +
        '<div class="options">' +
          '<div class="option fit" data-val="fit">← <strong>Fit</strong> <span class="key">Left</span></div>' +
          '<div class="timer-wrap">' +
            '<div class="timer">' +
              '<svg width="64" height="64">' +
                '<circle cx="32" cy="32" r="28" stroke="#2a3140" stroke-width="6" fill="none"></circle>' +
                '<circle id="ring" cx="32" cy="32" r="28" stroke="' + (isPractice?'#9ac6ff':'#58a6ff') + '" stroke-width="6" fill="none" stroke-linecap="round" ' +
                        'stroke-dasharray="' + (2*Math.PI*28) + '" stroke-dashoffset="0"></circle>' +
              '</svg>' +
              '<div class="time" id="time-left">5.0</div>' +
            '</div>' +
          '</div>' +
          '<div class="option not" data-val="not_fit"><strong>Doesn’t fit</strong> → <span class="key">Right</span></div>' +
        '</div>' +
        '<div class="legend mt16">Respond quickly. Time is limited.</div>' +
      '</div>';

    function teardown(){
      document.removeEventListener("keydown", keyHandler);
      stageEl.removeEventListener("click", clickHandler);
    }
    function decide(val){
      if (ended) return;
      ended = true;
      response = val;
      rt = Math.round(performance.now() - start);
      teardown();
      logEvent({
        event: isPractice ? "practice_trial" : "trial",
        trial_id: trialId,
        practice: isPractice,
        trial_index: isPractice ? state.practicePass : state.trialIdx,
        attribute: stim.attribute,
        brand: stim.brand,
        response: response,
        rt_ms: rt,
        timed_out: false
      });
      res(true);
    }
    function keyHandler(e){
      if (e.key === "ArrowLeft"){ e.preventDefault(); decide("fit"); }
      if (e.key === "ArrowRight"){ e.preventDefault(); decide("not_fit"); }
    }
    function clickHandler(e){
      var t = getOptionTarget(e.target);
      if (!t) return;
      decide(t.getAttribute("data-val"));
    }
    document.addEventListener("keydown", keyHandler);
    stageEl.addEventListener("click", clickHandler);

    // countdown
    var ring = stageEl.querySelector("#ring");
    var timeText = stageEl.querySelector("#time-left");
    var circumference = 2 * Math.PI * 28;
    var last = performance.now();
    var elapsed = 0;

    function raf(ts){
      if (ended) return;
      var dt = ts - last; last = ts;
      elapsed += dt;
      var remain = Math.max(0, FRONTEND_CONFIG.TRIAL_TIMEOUT_MS - elapsed);
      timeText.textContent = (remain/1000).toFixed(1);
      var frac = remain / FRONTEND_CONFIG.TRIAL_TIMEOUT_MS;
      ring.style.strokeDashoffset = String(circumference * (1 - frac));
      if (remain <= 0){
        ended = true; timedOut = true;
        teardown();
        logEvent({
          event: isPractice ? "practice_trial" : "trial",
          trial_id: trialId,
          practice: isPractice,
          trial_index: isPractice ? state.practicePass : state.trialIdx,
          attribute: stim.attribute,
          brand: stim.brand,
          response: null,
          rt_ms: null,
          timed_out: true
        });
        if (isPractice){
          stageEl.innerHTML = '<div class="center"><h2>Time’s up</h2><p class="mt8">Please answer within 5 seconds. Let’s try that one again.</p></div>';
        }
        res(false);
        return;
      }
      requestAnimationFrame(raf);
    }

    // Promise wrapper to resolve on end
    var res;
    var p = new Promise(function(resolve){ res = resolve; });
    requestAnimationFrame(function(ts){ last = ts; requestAnimationFrame(raf); });
    return p.then(function(ok){
      if (!timedOut) return sleep(250).then(function(){ return ok; });
      return sleep(900).then(function(){ return ok; });
    });
  });
}

/* ---- INIT / BINDINGS ---- */
document.addEventListener("DOMContentLoaded", function(){
  screens = {
    welcome: $("screen-welcome"),
    instructions: $("screen-instructions"),
    practice: $("screen-practice"),
    prelude: $("screen-prelude"),
    trial: $("screen-trial"),
    finish: $("screen-finish"),
    done: $("screen-done")
  };

  $("btn-begin").addEventListener("click", function(){
    var raw = ($("pname").value || "");
    state.participantName = raw.trim() || "Anonymous";
    logEvent({event:"session_start"});
    show("instructions");
  });

  $("btn-instr-back").addEventListener("click", function(){ show("welcome"); });
  $("btn-instr-next").addEventListener("click", function(){
    state.practiceIdx = 0; state.practicePass = 0;
    logEvent({event:"instructions_shown"});
    runPractice();
  });

  $("btn-start-main").addEventListener("click", function(){
    buildTrials();
    logEvent({event:"main_start", total_trials: state.trials.length});
    show("trial");
    runMain();
  });

  $("btn-submit").addEventListener("click", function(){
    var el = document.getElementById("submit-status");
    if (el) el.classList.remove("hidden");
    logEvent({event:"session_submit"});
    if (el) el.textContent = "Saved. Thank you!";
    setTimeout(function(){ show("done"); }, 500);
  });

  // restore queue (non-fatal)
  try {
    var saved = localStorage.getItem("fc_queue_" + state.sessionId);
    if (saved) { try { state.pendingQueue = JSON.parse(saved) || []; } catch(e){} }
  } catch(e){}
});
  </script>
</body>
</html>
